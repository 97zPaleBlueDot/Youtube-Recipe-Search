# ES 연구
## 요약
1. ES에서 지원하는 기능과 구성요소
    - 데이터를 인덱싱하여 저장, 검색 지원함
    - 역 인덱스 방식으로 일반적인 인덱스 방식보다 빠르게 문서 검색 가능함
    - 한국어 형태소 분석기를 통해 한국어도 지원 가능
    - API, JSON 형태로 통신함
2. index, shard, replica 개념과 설정의 필요성, Index 설계 시 고려 사항
    - 인덱스 index: 문서 document를 모아놓은 논리적인 집합
    - 샤드 shard : 인덱스의 내부에서 처리되는 물리적인 단위, 샤드가 여러 노드에 분산되어 저장됨
    - 프라이머리 샤드 primary shard, 레플리카 replica: 프라이머리 샤드들이 나누어 저장되고 그의 복제본인 레플리카가 서로 다른 노드에 분산 저장됨. 프라이머리 노드 손실 발생 시 레플리카 중 하나가 프라이머리 샤드로 승격되며 다른 노드에 레플리카 생성
    - 인덱스를 나누는 샤드의 개수는 지정하면 바꿀 수 없음. 재색인해야 함
    - 레플리카 개수는 이후에도 변경 가능
    - 적절한 성능을 위해 노드, 샤드, 레플리카 수 및 데이터 분배 알고리즘 등을 건드려 최적화할 수 있을 듯
    - 매핑: 어떤 데이터가 들어올지 등을 미리 선언하는 스태틱 매핑이 있고 매핑에 없는 데이터도 유연하게 들어오는 다이나믹 매핑이 있음. 검색 백엔드로 사용 예정이기 때문에 성능 최적화를 위해 명확하게 데이터 모델을 명시하는 게 좋을 듯 함
3. querydsl 기능, 사용법, 러닝커브
    - SQL과는 다른 데이터 쿼리 방식
    - JSON 형식으로 쿼리를 입력 받고 결과를 출력함
    - 정확도(스코어가 알아서 계산됨), 참, 거짓 여부 등을 응용하여 다양한 검색 가능
    - 쿼리, api 활용에 능숙하다면 그렇게 어렵지 않을 것으로 보임
4. 유사어 검색
    - 토큰 필터 기능을 통해 해결 가능
    - 한국어 형태소 분석기와 그 사용자 사전 관리 필요(고유명사, 합성어가 많은 음식명이라 중요할 듯)
    - 검색 정확도에 대한 스코어도 제공함

## 필요 사양
### ES 최소사양
- CPU: 2 Cores
- 메모리: 4GB
- 클러스터 노드 수는 최소 3개 권장(1개 쓰는 스탠드얼론 모드도 가능한 듯)

## 데이터 색인
### 역색인구조 Inverted Index
특정 키워드(Term이라고 함)를 포함하고 있는 문서(Document)들에 대한 Key를 맵핑하는 인덱스 테이블을 생성
키워드가 주어지면 인덱스 테이블을 검색해 빠르게 그 키워드가 포함된 문서를 찾을 수 있음

#### 해시 자료구조 사용 시 예시
예시 텍스트
- 1. I have a gun.
- 2. I love you.
- 3. You just activated my trap card.
- 4. I want you to go home.

인덱스 테이블
- Term: Docs
- I: 1, 2, 4
- You: 2, 3, 4
- ...

### 설정 Settings
- 샤드 수
- 레플리카 수
- 애널라이저
    - 토크나이저
    - 토큰 필터
- etc 다양한 설정을 인덱스에 해줄 수 있음
### 매핑 Mappings
- 데이터 형태 등을 미리 정의하는 정적 매핑과 유연성 있는 동적 매핑이 있음
- 동적 매핑은 편리하여 정적 매핑에 비해 초기 세팅 시간이 덜 걸리고 유연하나 성능, 일관성, 디스크 사용 면에서 단점이 있음

## 텍스트 처리 과정
애널라이저 Analyzer가 텍스트를 처리함
애널라이저는 0~3대의 캐릭터 필터, 토크나이저 1개, 토큰필터 0~n개로 구성
캐릭터 필터 -> 토크나이저 -> 토큰 필터
### 캐릭터 필터
- 텍스트가 입력되면 전체 문장에서 특정 문자를 대치하거나 제거하는 과정을 담당
### 토크나이저
- 입력된 텍스트를 Term 단위로 분해
### 토큰 필터
- 분리된 텀들을 가공함
- 대소문자, 동의어, 불용어 등 지정 가능

## 형태소 분석기
우린 한국어 서비스를 해야하기 때문에 매우 종요함
음식은 특히 합성어가 많기 때문에 신경 써야 할 부분
### 노리 형태소 분석기
- ES의 플러그인
- 토크나이저와 토큰 필터를 제공하여 일반적인 토크나이저로 분리하기 힘든 한글 다루기 용이함
- 사용자 사전에 따라 분석할 때 단어의 우선순위가 결정되므로 경우에 따라서 우리는 음식 위주의 사전을 재구성해야할 수 있음

## 쿼리
- SQL도 높은 버젼, 라이센스에서 지원하나 api, json 형식의 queryDSL로 검색함
- boolean과 정확도, 숫자나 날짜 등을 조합하여 다양한 검색이 가능함
### 불 타입 Boolean
문서에 단어가 포함되었는지를 따져 참과 거짓(bool)로 구분
### 정확도
문서를 BM25라는 알고리즘으로 정확도 스코어를 계산해놓음
정확도로 정렬하는 등 응용 가능


## References
### ES 인덱스 관련 글
https://velog.io/@koo8624/Database-Elastic-Search-1%ED%8E%B8-%EC%97%AD%EC%83%89%EC%9D%B8Inverted-Index%EA%B3%BC-%ED%98%95%ED%83%9C%EC%86%8C-%EB%B6%84%EC%84%9D

### 김종민씨 가이드북
https://esbook.kimjmin.net/

### EC2에서 ES 클러스터 경험
https://haandol.github.io/2020/03/05/elasticsearch-aws-ecs-ec2.html